
-- the Geography dimension. Creates a standard geography that is valid throughout the time period covered
-- Mostly the same as today's province names with a couple of quirks, notably, all the
-- Northern provinces are amalgamated, because they don't exist throughout the whole period covered.
-- the Geo Names table. Gets converted to the ROLAP DimGeo table. Probably redundant

DROP TABLE IF EXISTS dim_geography
;

CREATE TABLE dim_geography(
	geo_name_pk nvarchar(255) NOT NULL,
	standardised_province nvarchar(255) NULL
) 
;


-- Creative Industry naics codes.

DROP TABLE IF EXISTS dim_industry
;

CREATE TABLE dim_industry(
	pnaics nvarchar(7) NOT NULL,
	naics6 nvarchar(7) NULL,
	naics5 nvarchar(7) NULL,
	naics4 nvarchar(7) NULL,
	naics3 nvarchar(7) NULL,
	naics2 nvarchar(7) NULL,
	creative_sector nvarchar (255) NULL
) 
;


DROP TABLE IF EXISTS dim_occupations
;

CREATE TABLE dim_occupations(
	anocs4 nvarchar(5) NULL,	
	o_nesta nvarchar(5) NULL,	
	o_higgs nvarchar(5) NULL,	
	o_freeman nvarchar(8) NULL,
	occupation_description nvarchar (255) NULL,	
	creative_occupation nvarchar(12) NULL
) 
;

DROP TABLE IF EXISTS industry_descriptions
;

CREATE TABLE industry_descriptions(
	naics6 nvarchar(6) NULL,	
	description nvarchar(255) NULL	
) 
;


-- This table eventually contains all the industry data.
-- It has to combine data from four different sources that are each coded differently.
-- and it contains a variety of indicators (jobs, real GDP, GDP, hours, possibly more as the project expands).
-- This is the reason for the complexity.Each source has to be pre-processed before it is
-- finally moved into here.

DROP TABLE IF EXISTS fact 
;
CREATE TABLE fact (
	 factpk int NOT NULL IDENTITY(1,1) ,
	 source nvarchar (255) NULL, /*the name of the source of the data eg 'cansim-0930333', 'census', etc*/
	 indicator nvarchar (256) NULL, /* what the numeric field measures, eg 'jobs', 'real GDP', etc */
	 pnaics nvarchar (7) NULL, /* The standardised pnaics industry code */
	 pnaics_description nvarchar (255) NULL,
	 geo_name nvarchar (255) NULL,
	 year nvarchar (10) NULL, /* EG '2010 M01' or '2018' or '2018 Q01'*/
	 value float NULL)
;

-- Table for the census results

DROP TABLE IF EXISTS census 
;

CREATE TABLE census (
	geo_name	 nvarchar (255) NULL,
	anaics4	 nvarchar (5) NULL,
	anocs4	 nvarchar (5)NULL,
	occupation_description nvarchar (255)NULL,	
	industry_description nvarchar (255)NULL,
Value float 
) 
;

DROP VIEW IF EXISTS creative_industries 
;

CREATE VIEW creative_industries AS

SELECT 
	industries.value, 
	industries.year, 
	industries.indicator, 
	industries.standardised_province , 
	industries.Source, 
	industries.creative_sector , 
	industries.naics4, 
	industry_descriptions.description

FROM 

(SELECT 
SUM(fact.value) AS value, 
	fact.year, 
	fact.indicator, 
	dim_geography.standardised_province , 
	fact.Source, 
	dim_industry.creative_sector , 
	fact.pnaics, 
	dim_industry.pnaics AS ni_pnaics, 
	dim_industry.naics6, 
	dim_industry.naics5, 
	dim_industry.naics4, 
	dim_industry.naics3, 
	dim_industry.naics2

FROM 
dim_geography 
RIGHT OUTER JOIN
	fact ON dim_geography.geo_name_pk = fact.geo_name 
RIGHT OUTER JOIN
	dim_industry ON fact.pnaics = dim_industry.pnaics
GROUP BY 
	dim_industry.creative_sector , 
	fact.source, 
	dim_geography.standardised_province , 
	fact.indicator, 
	fact.geo_name, 
	fact.year, 
	fact.pnaics, 
	dim_industry.pnaics, 
	dim_industry.naics6, 
	dim_industry.naics5, 
	dim_industry.naics4, 
	dim_industry.naics3, 
	dim_industry.naics2, 
	fact.value) AS industries 
	LEFT OUTER JOIN
industry_descriptions ON industries.naics4 = industry_descriptions.naics6
;

DROP VIEW IF EXISTS industries 
;

CREATE VIEW industries 
AS
SELECT 
SUM(fact.value) AS value, 
	fact.year, 
	fact.indicator, 
	dim_geography.standardised_province , 
	fact.source, 
	dim_industry.creative_sector , 
	fact.pnaics, 
	dim_industry.pnaics AS ni_pnaics,
	dim_industry.naics6, 
	dim_industry.naics5, 
	dim_industry.naics4, 
	dim_industry.naics3, 
	dim_industry.naics2
FROM
	dim_geography 
RIGHT OUTER JOIN
fact ON dim_geography.geo_name_pk = fact.geo_name 
RIGHT OUTER JOIN
dim_industry ON fact.pnaics = dim_industry.pnaics
GROUP BY 
	dim_industry.creative_sector , 
	fact.Source, 
	dim_geography.standardised_province , 
	fact.indicator, 
	fact.geo_name, 
	fact.year, 
	fact.pnaics, 
	dim_industry.pnaics, 
	dim_industry.naics6, 
	dim_industry.naics5, 
	dim_industry.naics4, 
	dim_industry.naics3, 
	dim_industry.naics2, 
	fact.value
;


